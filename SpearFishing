local LMG2L = {};
local player = game:GetService("Players").LocalPlayer
local UIS = game:GetService("UserInputService")
local TweenService = game:GetService("TweenService")
local RunService = game:GetService("RunService")
local Workspace = game:GetService("Workspace")

LMG2L["ScreenGui_1"] = Instance.new("ScreenGui", game:GetService("Players").LocalPlayer:WaitForChild("PlayerGui"));
LMG2L["ScreenGui_1"]["ZIndexBehavior"] = Enum.ZIndexBehavior.Sibling;
LMG2L["ScreenGui_1"]["ResetOnSpawn"] = false;


LMG2L["Frame_2"] = Instance.new("Frame", LMG2L["ScreenGui_1"]);
LMG2L["Frame_2"]["BorderSizePixel"] = 0;
LMG2L["Frame_2"]["BackgroundColor3"] = Color3.fromRGB(0, 0, 0);
LMG2L["Frame_2"]["Size"] = UDim2.new(0, 200, 0, 76);
LMG2L["Frame_2"]["Position"] = UDim2.new(0, 254, 0, 66);


LMG2L["UICorner_3"] = Instance.new("UICorner", LMG2L["Frame_2"]);



LMG2L["UIStroke_4"] = Instance.new("UIStroke", LMG2L["Frame_2"]);



LMG2L["TextBox_5"] = Instance.new("TextBox", LMG2L["Frame_2"]);
LMG2L["TextBox_5"]["BorderSizePixel"] = 0;
LMG2L["TextBox_5"]["TextSize"] = 14;
LMG2L["TextBox_5"]["BackgroundColor3"] = Color3.fromRGB(255, 255, 255);
LMG2L["TextBox_5"]["FontFace"] = Font.new([[rbxasset://fonts/families/Inconsolata.json]], Enum.FontWeight.Regular, Enum.FontStyle.Normal);
LMG2L["TextBox_5"]["Size"] = UDim2.new(0, 188, 0, 18);
LMG2L["TextBox_5"]["Position"] = UDim2.new(0, 6, 0, 4);
LMG2L["TextBox_5"]["Text"] = [[DUMINIKGG - SPEAR FISHING]];
LMG2L["TextBox_5"]["TextEditable"] = false;


LMG2L["UICorner_6"] = Instance.new("UICorner", LMG2L["TextBox_5"]);



LMG2L["UIDragDetector_7"] = Instance.new("UIDragDetector", LMG2L["Frame_2"]);



LMG2L["TextButton_8"] = Instance.new("TextButton", LMG2L["Frame_2"]);
LMG2L["TextButton_8"]["BorderSizePixel"] = 0;
LMG2L["TextButton_8"]["TextSize"] = 14;
LMG2L["TextButton_8"]["BackgroundColor3"] = Color3.fromRGB(255, 0, 0);
LMG2L["TextButton_8"]["FontFace"] = Font.new([[rbxasset://fonts/families/Inconsolata.json]], Enum.FontWeight.Regular, Enum.FontStyle.Normal);
LMG2L["TextButton_8"]["Size"] = UDim2.new(0, 140, 0, 38);
LMG2L["TextButton_8"]["Text"] = [[AUTO FARM : OFF]];
LMG2L["TextButton_8"]["Position"] = UDim2.new(0, 30, 0, 32);


LMG2L["UICorner_9"] = Instance.new("UICorner", LMG2L["TextButton_8"]);

-- Auto Farm Variables
local autoFarm = false
local isTweening = false
local currentTween = nil
local originalHumanoidState = nil

-- Drag functionality for the frame
local dragging = false
local dragStart
local startPosFrame

local function update(input)
    local delta = input.Position - dragStart
    LMG2L["Frame_2"].Position = UDim2.new(
        startPosFrame.X.Scale,
        startPosFrame.X.Offset + delta.X,
        startPosFrame.Y.Scale,
        startPosFrame.Y.Offset + delta.Y
    )
end

local function dragBegin(input)
    dragging = true
    dragStart = input.Position
    startPosFrame = LMG2L["Frame_2"].Position
end

local function dragEnd(input)
    dragging = false
end

-- Connect drag events to the frame
LMG2L["Frame_2"].InputBegan:Connect(function(input)
    if input.UserInputType == Enum.UserInputType.MouseButton1
    or input.UserInputType == Enum.UserInputType.Touch then
        dragBegin(input)
    end
end)

LMG2L["Frame_2"].InputEnded:Connect(dragEnd)

UIS.InputChanged:Connect(function(input)
    if dragging and (input.UserInputType == Enum.UserInputType.MouseMovement
        or input.UserInputType == Enum.UserInputType.Touch) then
        update(input)
    end
end)

-- Function to get nearest fish with priority for bigger fish
local function getNearestRoot()
    local bestFish = nil
    local bestScore = -math.huge

    local char = player.Character
    if not char or not char:FindFirstChild("HumanoidRootPart") then return nil end

    local hrp = char.HumanoidRootPart

    for _, sea in ipairs(Workspace.WorldSea:GetChildren()) do
        for _, fish in ipairs(sea:GetChildren()) do
            -- Check if it's a fish and has the proper structure
            if fish:FindFirstChild("Model") and fish.Model:FindFirstChild("Root") then
                local root = fish.Model.Root
                local dist = (root.Position - hrp.Position).Magnitude
                
                -- Check if fish is in water (not dead/collected)
                local fishState = fish:FindFirstChild("State")
                if fishState and fishState.Value == "Dead" then
                    continue
                end
                
                -- Calculate a score based on distance and fish size
                -- Bigger fish usually have different names or properties
                local fishName = fish.Name:lower()
                local sizeMultiplier = 1
                
                -- Prioritize bigger fish
                if fishName:find("big") or fishName:find("large") or fishName:find("huge") then
                    sizeMultiplier = 3
                elseif fishName:find("medium") then
                    sizeMultiplier = 2
                end
                
                -- Also check for visual size
                local modelSize = fish.Model:GetExtentsSize()
                local volume = modelSize.X * modelSize.Y * modelSize.Z
                if volume > 50 then  -- Big fish have larger volume
                    sizeMultiplier = math.max(sizeMultiplier, 3)
                end
                
                -- Score calculation: prioritize closer AND bigger fish
                local score = (1000 - dist) * sizeMultiplier
                
                if score > bestScore then
                    bestScore = score
                    bestFish = root
                end
            end
        end
    end

    return bestFish
end

-- Improved teleport function with better positioning
local function safeTeleport(root)
    if not root then return false end
    
    local char = player.Character
    if not char or not char:FindFirstChild("HumanoidRootPart") then 
        isTweening = false
        return false 
    end
    
    local hrp = char.HumanoidRootPart
    local humanoid = char:FindFirstChild("Humanoid")
    
    if not humanoid then
        isTweening = false
        return false
    end
    
    -- Save original humanoid state
    originalHumanoidState = {
        PlatformStand = humanoid.PlatformStand,
        AutoRotate = humanoid.AutoRotate
    }
    
    -- Prepare character for teleport
    humanoid.PlatformStand = false  -- Changed to false for better spear mechanics
    humanoid.AutoRotate = true
    
    -- Calculate teleport position
    -- Teleport to a position near the fish but not too close
    local fishDirection = (root.Position - hrp.Position).Unit
    local teleportDistance = 20  -- Distance from fish to teleport
    local teleportPosition = root.Position - (fishDirection * teleportDistance)
    teleportPosition = Vector3.new(teleportPosition.X, teleportPosition.Y + 2, teleportPosition.Z)  -- Slightly above
    
    -- Use CFrame for proper orientation
    local targetCFrame = CFrame.new(teleportPosition, root.Position)
    
    -- Direct teleport instead of tween for better accuracy
    hrp.CFrame = targetCFrame
    
    -- Small delay for stabilization
    task.wait(0.2)
    
    -- Restore humanoid state
    if originalHumanoidState then
        humanoid.PlatformStand = originalHumanoidState.PlatformStand
        humanoid.AutoRotate = originalHumanoidState.AutoRotate
    end
    
    isTweening = false
    return true
end

local function findTool()
    local char = player.Character
    if not char then return nil end

    -- Look for spear tools
    for _, item in ipairs(char:GetChildren()) do
        if item:IsA("Tool") and (item.Name:lower():find("spear") or item.Name:lower():find("harpoon")) then
            return item
        end
    end
    
    -- Also check backpack
    local backpack = player:FindFirstChild("Backpack")
    if backpack then
        for _, item in ipairs(backpack:GetChildren()) do
            if item:IsA("Tool") and (item.Name:lower():find("spear") or item.Name:lower():find("harpoon")) then
                -- Equip the tool
                item.Parent = char
                task.wait(0.1)
                return item
            end
        end
    end

    return nil
end

-- Improved auto-cast function
local function autoCast(root)
    if not root then return false end

    local tool = findTool()
    if not tool then 
        warn("No spear tool found!")
        return false
    end
    
    -- Wait a bit for tool to be properly equipped
    task.wait(0.1)
    
    -- Get camera for aiming
    local camera = Workspace.CurrentCamera
    
    -- Calculate aim position (aim slightly ahead of fish for leading)
    local fishVelocity = Vector3.new(0, 0, 0)
    -- Try to get fish velocity if available
    if root.Parent and root.Parent.Parent then
        local fishModel = root.Parent
        local fishVelocityPart = fishModel:FindFirstChild("Velocity") or fishModel:FindFirstChild("Root")
        if fishVelocityPart then
            fishVelocity = fishVelocityPart.Velocity or Vector3.new(0, 0, 0)
        end
    end
    
    -- Predict fish position based on velocity
    local predictionTime = 0.3  -- Time to predict ahead
    local predictedPosition = root.Position + (fishVelocity * predictionTime)
    
    -- Fire the spear
    local args = {
        [1] = "Fire",
        [2] = {
            cameraOrigin = camera.CFrame.Position,
            player = player,
            toolInstance = tool,
            destination = predictedPosition,  -- Use predicted position
            isCharge = true  -- Always use charged throw for bigger fish
        }
    }

    local success = pcall(function()
        game:GetService("ReplicatedStorage").Remotes.FireRE:FireServer(unpack(args))
    end)
    
    if success then
        print("Spear fired at fish!")
    else
        warn("Failed to fire spear!")
    end
    
    return success
end

-- Auto Farm Loop with better timing
task.spawn(function()
    while true do
        if autoFarm and not isTweening then
            local root = getNearestRoot()
            if root then
                isTweening = true
                
                -- Check if we have a spear equipped
                local tool = findTool()
                if not tool then
                    warn("No spear equipped. Please equip a spear first!")
                    isTweening = false
                    task.wait(1)
                    continue
                end
                
                -- Teleport to fish
                local teleportSuccess = safeTeleport(root)
                if teleportSuccess then
                    -- Wait for stabilization and aim
                    task.wait(0.3)
                    
                    -- Fire at fish
                    autoCast(root)
                    
                    -- Wait before next action
                    task.wait(1.5)  -- Increased wait time for spear recovery
                else
                    task.wait(0.5)
                end
                isTweening = false
            else
                task.wait(1)  -- Wait longer if no fish found
            end
        end
        task.wait(0.1)  -- Slightly longer loop interval
    end
end)

-- Toggle Auto Farm
LMG2L["TextButton_8"].MouseButton1Click:Connect(function()
    autoFarm = not autoFarm
    if autoFarm then
        LMG2L["TextButton_8"].Text = "AUTO FARM : ON"
        LMG2L["TextButton_8"].BackgroundColor3 = Color3.fromRGB(0, 255, 0)
        
        -- Check if player has spear equipped
        local tool = findTool()
        if not tool then
            warn("WARNING: No spear detected! Auto farm may not work properly.")
        end
    else
        -- Stop any ongoing tween
        if currentTween then
            currentTween:Cancel()
            currentTween = nil
        end
        
        -- Restore humanoid state if we were tweening
        if isTweening then
            local char = player.Character
            if char and char:FindFirstChild("Humanoid") and originalHumanoidState then
                local humanoid = char.Humanoid
                humanoid.PlatformStand = originalHumanoidState.PlatformStand
                humanoid.AutoRotate = originalHumanoidState.AutoRotate
            end
            isTweening = false
        end
        
        LMG2L["TextButton_8"].Text = "AUTO FARM : OFF"
        LMG2L["TextButton_8"].BackgroundColor3 = Color3.fromRGB(255, 0, 0)
    end
end)

return LMG2L["ScreenGui_1"], require;
